/**
 * @license Copyright (c) 2003-2017, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
"use strict";(function(){var isBrowserSupported=!CKEDITOR.env.ie||CKEDITOR.env.version>8;CKEDITOR.plugins.add("codesnippet",{requires:"widget,dialog",lang:"ar,az,bg,ca,cs,da,de,de-ch,el,en,en-au,en-gb,eo,es,es-mx,et,eu,fa,fi,fr,fr-ca,gl,he,hr,hu,id,it,ja,km,ko,ku,lt,lv,nb,nl,no,oc,pl,pt,pt-br,ro,ru,sk,sl,sq,sv,th,tr,tt,ug,uk,vi,zh,zh-cn",icons:"codesnippet",hidpi:true,beforeInit:function(editor){editor._.codesnippet={};this.setHighlighter=function(highlighter){editor._.codesnippet.highlighter=highlighter;var langs=editor._.codesnippet.langs=editor.config.codeSnippet_languages||highlighter.languages;editor._.codesnippet.langsRegex=new RegExp("(?:^|\\s)language-("+CKEDITOR.tools.objectKeys(langs).join("|")+")(?:\\s|$)")}},onLoad:function(){CKEDITOR.dialog.add("codeSnippet",this.path+"dialogs/codesnippet.js")},init:function(editor){editor.ui.addButton&&editor.ui.addButton("CodeSnippet",{label:editor.lang.codesnippet.button,command:"codeSnippet",toolbar:"insert,10"})},afterInit:function(editor){var path=this.path;registerWidget(editor);if(!editor._.codesnippet.highlighter){var hljsHighlighter=new CKEDITOR.plugins.codesnippet.highlighter({languages:{apache:"Apache",bash:"Bash",coffeescript:"CoffeeScript",cpp:"C++",cs:"C#",css:"CSS",diff:"Diff",html:"HTML",http:"HTTP",ini:"INI",isbl:"ISBL",java:"Java",javascript:"JavaScript",json:"JSON",makefile:"Makefile",markdown:"Markdown",nginx:"Nginx",objectivec:"Objective-C",perl:"Perl",php:"PHP",python:"Python",ruby:"Ruby",sql:"SQL",vbscript:"VBScript",xhtml:"XHTML",xml:"XML"},init:function(callback){var that=this;if(isBrowserSupported){CKEDITOR.scriptLoader.load(path+"lib/highlight/highlight.pack.js",(function(){that.hljs=window.hljs;callback()}))}if(editor.addContentsCss){editor.addContentsCss(path+"lib/highlight/styles/"+editor.config.codeSnippet_theme+".css")}},highlighter:function(code,language,callback){var highlighted=this.hljs.highlightAuto(code,this.hljs.getLanguage(language)?[language]:undefined);if(highlighted)callback(highlighted.value)}});this.setHighlighter(hljsHighlighter)}}});CKEDITOR.plugins.codesnippet={highlighter:Highlighter};function Highlighter(def){CKEDITOR.tools.extend(this,def);this.queue=[];if(this.init){this.init(CKEDITOR.tools.bind((function(){var job;while(job=this.queue.pop())job.call(this);this.ready=true}),this))}else{this.ready=true}}Highlighter.prototype.highlight=function(){var arg=arguments;if(this.ready)this.highlighter.apply(this,arg);else{this.queue.push((function(){this.highlighter.apply(this,arg)}))}};function registerWidget(editor){var codeClass=editor.config.codeSnippet_codeClass,newLineRegex=/\r?\n/g,textarea=new CKEDITOR.dom.element("textarea"),lang=editor.lang.codesnippet;editor.widgets.add("codeSnippet",{allowedContent:"pre; code(language-*)",requiredContent:"pre",styleableElements:"pre",template:'<pre><code class="'+codeClass+'"></code></pre>',dialog:"codeSnippet",pathName:lang.pathName,mask:true,parts:{pre:"pre",code:"code"},highlight:function(){var that=this,widgetData=this.data,callback=function(formatted){that.parts.code.setHtml(isBrowserSupported?formatted:formatted.replace(newLineRegex,"<br>"))};callback(CKEDITOR.tools.htmlEncode(widgetData.code));editor._.codesnippet.highlighter.highlight(widgetData.code,widgetData.lang,(function(formatted){editor.fire("lockSnapshot");callback(formatted);editor.fire("unlockSnapshot")}))},data:function(){var newData=this.data,oldData=this.oldData;if(newData.code)this.parts.code.setHtml(CKEDITOR.tools.htmlEncode(newData.code));if(oldData&&newData.lang!=oldData.lang)this.parts.code.removeClass("language-"+oldData.lang);if(newData.lang){this.parts.code.addClass("language-"+newData.lang);this.highlight()}this.oldData=CKEDITOR.tools.copy(newData)},upcast:function(el,data){if(el.name!="pre")return;var childrenArray=getNonEmptyChildren(el),code;if(childrenArray.length!=1||(code=childrenArray[0]).name!="code")return;if(code.children.length!=1||code.children[0].type!=CKEDITOR.NODE_TEXT)return;var matchResult=editor._.codesnippet.langsRegex.exec(code.attributes["class"]);if(matchResult)data.lang=matchResult[1];textarea.setHtml(code.getHtml());data.code=textarea.getValue();code.addClass(codeClass);return el},downcast:function(el){var code=el.getFirst("code");code.children.length=0;code.removeClass(codeClass);code.add(new CKEDITOR.htmlParser.text(CKEDITOR.tools.htmlEncode(this.data.code)));return el}});var whitespaceOnlyRegex=/^[\s\n\r]*$/;function getNonEmptyChildren(parentElement){var ret=[],preChildrenList=parentElement.children,curNode;for(var i=preChildrenList.length-1;i>=0;i--){curNode=preChildrenList[i];if(curNode.type!=CKEDITOR.NODE_TEXT||!curNode.value.match(whitespaceOnlyRegex))ret.push(curNode)}return ret}}})();CKEDITOR.config.codeSnippet_codeClass="hljs";CKEDITOR.config.codeSnippet_theme="isbl-editor-light";